#!/bin/bash -x
# Bootstrap for Red Hat Enterprise Linux Platform
# Compatible with RHEL 7, CentOS 7 and maybe other variations.
(
exec 1> >(logger -s -t user-data) 2>&1

rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm

yum update --assumeyes
yum install --assumeyes puppet ruby-devel rubygems gcc zlib-devel libxml2-devel patch

gem install pupistry
mkdir /etc/pupistry
cat > /etc/pupistry/settings.yaml << "EOF"
general:
  app_cache: ~/.pupistry/cache
  s3_bucket: <%= s3_bucket %>
  s3_prefix: <%= s3_prefix %>
  gpg_disable: <%= gpg_disable %>
  gpg_signing_key: <%= gpg_signing_key %>
agent:
  puppetcode: <%= puppetcode %>
  access_key_id: <%= access_key_id %>
  secret_access_key: <%= secret_access_key %>
  region: <%= region %>
  proxy_uri: <%= proxy_uri %>
EOF
pupistry apply --verbose

)
